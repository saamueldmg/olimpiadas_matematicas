<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Iniciar Concurso - Olimpiadas Matemáticas</title>
    <!-- Tailwind CSS y Fuentes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome para los iconos -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }
      .level-button {
        transition: all 0.2s ease-in-out;
        opacity: 0.5; /* Empezar semi-transparentes */
        cursor: pointer;
      }
      .level-button.active {
        opacity: 1;
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }
      select:disabled {
        background-color: #f3f4f6; /* bg-gray-100 */
        cursor: not-allowed;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen p-4 sm:p-6 md:p-8">
    <!-- Datos de Python a JavaScript -->
    <script>
      const teamsData = {
          nivel1: {{ teams_n1 | tojson }},
          nivel2: {{ teams_n2 | tojson }}
      };
    </script>

    <div class="container mx-auto max-w-5xl">
      <!-- Encabezado -->
      <header
        class="flex flex-col sm:flex-row justify-between items-center mb-8"
      >
        <div class="flex items-center space-x-4">
          <div class="bg-purple-100 text-purple-600 p-4 rounded-2xl">
            <i class="fas fa-play-circle text-3xl"></i>
          </div>
          <div>
            <h1 class="text-3xl font-bold text-gray-800">Iniciar Concurso</h1>
            <p class="text-gray-500">
              Prepara la competencia seleccionando los equipos y el nivel.
            </p>
          </div>
        </div>
        <a
          href="{{ url_for('dashboard') }}"
          class="mt-4 sm:mt-0 flex items-center space-x-2 text-gray-600 hover:text-blue-600 transition-colors font-medium"
        >
          <i class="fas fa-arrow-left"></i>
          <span>Volver al Dashboard</span>
        </a>
      </header>

      <!-- Contenido Principal -->
      <main class="bg-white p-8 rounded-2xl shadow-lg">
        {% if error %}
        <div
          class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg mb-6"
          role="alert"
        >
          <p class="font-bold">¡Atención!</p>
          <p>{{ error }}</p>
        </div>
        {% endif %}

        <form
          id="quiz-form"
          action="{{ url_for('select_level') }}"
          method="post"
          class="space-y-8"
        >
          <!-- Input oculto para el nivel -->
          <input type="hidden" name="level" id="selected-level" value="" />

          <!-- Sección 1: Selección de Nivel (AHORA PRIMERO) -->
          <section>
            <h2 class="text-2xl font-bold text-gray-700 mb-4">
              1. Elige el Nivel del Desafío
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div
                id="btn-nivel1"
                data-level="Nivel I"
                data-key="nivel1"
                class="level-button bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-6 px-6 rounded-xl shadow-lg text-center"
              >
                <span class="text-2xl">Nivel I</span>
                <span class="block text-sm opacity-80">(6° - 7°)</span>
              </div>
              <div
                id="btn-nivel2"
                data-level="Nivel II"
                data-key="nivel2"
                class="level-button bg-gradient-to-r from-purple-500 to-purple-600 text-white font-bold py-6 px-6 rounded-xl shadow-lg text-center"
              >
                <span class="text-2xl">Nivel II</span>
                <span class="block text-sm opacity-80">(8° - 9°)</span>
              </div>
              <div
                id="btn-nivel3"
                data-level="Nivel III"
                data-key="nivel3"
                class="level-button bg-gradient-to-r from-red-500 to-red-600 text-white font-bold py-6 px-6 rounded-xl shadow-lg text-center"
              >
                <span class="text-2xl">Nivel III</span>
                <span class="block text-sm opacity-80">(10° - 11°)</span>
              </div>
            </div>
          </section>

          <!-- Sección 2: Selección de Equipos (AHORA SEGUNDO) -->
          <section>
            <h2 class="text-2xl font-bold text-gray-700 mb-4">
              2. Selecciona los Contendientes
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div>
                <label
                  for="team1"
                  class="block text-lg font-medium text-gray-600 mb-2"
                  >Equipo 1</label
                >
                <select
                  name="team1"
                  id="team1"
                  required
                  class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg"
                  disabled
                >
                  <option value="">(Selecciona un nivel primero)</option>
                </select>
              </div>
              <div>
                <label
                  for="team2"
                  class="block text-lg font-medium text-gray-600 mb-2"
                  >Equipo 2</label
                >
                <select
                  name="team2"
                  id="team2"
                  required
                  class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg"
                  disabled
                >
                  <option value="">(Selecciona un nivel primero)</option>
                </select>
              </div>
            </div>
          </section>

          <!-- Botón de Envío -->
          <div class="text-center pt-4">
            <button
              id="submit-button"
              type="submit"
              class="w-full md:w-1/2 bg-gray-400 text-white font-bold py-4 px-12 rounded-lg shadow-lg transition-colors cursor-not-allowed"
              disabled
            >
              Selecciona un Nivel
            </button>
          </div>
        </form>
      </main>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const team1Select = document.getElementById("team1");
        const team2Select = document.getElementById("team2");
        const selectedLevelInput = document.getElementById("selected-level");
        const submitButton = document.getElementById("submit-button");
        const form = document.getElementById("quiz-form");

        const levelButtons = [
          document.getElementById("btn-nivel1"),
          document.getElementById("btn-nivel2"),
          document.getElementById("btn-nivel3"),
        ];

        function populateSelect(selectElement, teams) {
          selectElement.innerHTML = ""; // Limpiar opciones

          if (!teams || teams.length === 0) {
            selectElement.disabled = true;
            selectElement.innerHTML =
              '<option value="">No hay equipos para este nivel</option>';
            return;
          }

          selectElement.disabled = false;
          selectElement.innerHTML =
            '<option value="" disabled selected>Selecciona un equipo...</option>';

          teams.forEach((team) => {
            const option = document.createElement("option");
            option.value = team;
            option.textContent = team;
            selectElement.appendChild(option);
          });
        }

        levelButtons.forEach((button) => {
          button.addEventListener("click", (e) => {
            e.preventDefault(); // Evitar que el form se envíe

            // Manejar estado visual
            levelButtons.forEach((btn) => btn.classList.remove("active"));
            button.classList.add("active");

            const levelName = button.dataset.level; // "Nivel I"
            const levelKey = button.dataset.key; // "nivel1"

            // Guardar el nivel seleccionado
            selectedLevelInput.value = levelName;

            // Llenar los menús desplegables
            const teamsForLevel = teamsData[levelKey] || [];
            populateSelect(team1Select, teamsForLevel);
            populateSelect(team2Select, teamsForLevel);

            // Activar botón de envío
            if (teamsForLevel.length > 0) {
              submitButton.disabled = false;
              submitButton.textContent = `Iniciar Duelo - ${levelName}`;
              submitButton.classList.remove(
                "bg-gray-400",
                "cursor-not-allowed"
              );
              submitButton.classList.add(
                "bg-purple-600",
                "hover:bg-purple-700"
              );
            } else {
              submitButton.disabled = true;
              submitButton.textContent = `No hay equipos para ${levelName}`;
              submitButton.classList.add("bg-gray-400", "cursor-not-allowed");
              submitButton.classList.remove(
                "bg-purple-600",
                "hover:bg-purple-700"
              );
            }
          });
        });

        // Lógica para evitar selección duplicada
        function syncSelectors(changedSelect, targetSelect) {
          if (changedSelect.value === targetSelect.value) {
            targetSelect.selectedIndex = 0; // Resetear al placeholder
          }
        }
        team1Select.addEventListener("change", () =>
          syncSelectors(team1Select, team2Select)
        );
        team2Select.addEventListener("change", () =>
          syncSelectors(team2Select, team1Select)
        );

        // Envío final del formulario
        form.addEventListener("submit", (e) => {
          if (!selectedLevelInput.value) {
            e.preventDefault();
            alert(
              "Por favor, selecciona un nivel haciendo clic en uno de los botones."
            );
          }
        });
      });
    </script>
  </body>
</html>
