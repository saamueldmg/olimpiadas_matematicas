from flask import Flask, render_template, request, redirect, url_for, session,
jsonify from flask_login import LoginManager, UserMixin, login_user,
login_required, logout_user, current_user from werkzeug.security import
generate_password_hash, check_password_hash from werkzeug.utils import
secure_filename import random import os import json import firebase_admin from
firebase_admin import credentials, firestore app = Flask(__name__)
app.secret_key = 'una-clave-super-secreta' login_manager = LoginManager()
login_manager.init_app(app) login_manager.login_view = 'login' UPLOAD_FOLDER =
'static/images' app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER # Firebase Admin SDK
is initialized in the following try-except block try: if not
firebase_admin._apps: # A placeholder file name cred =
credentials.Certificate("serviceAccountKey.json")
firebase_admin.initialize_app(cred) except ValueError: pass db =
firestore.client() class User(UserMixin): def __init__(self, id): self.id = id
def get_id(self): return str(self.id) users = {"admin": {"password":
generate_password_hash("password")}} @login_manager.user_loader def
load_user(user_id): if user_id in users: return User(user_id) return None
@app.route('/login', methods=['GET', 'POST']) def login(): if request.method ==
'POST': username = request.form['username'] password = request.form['password']
user = users.get(username) if user and check_password_hash(user['password'],
password): login_user(User(username)) return redirect(url_for('dashboard'))
return render_template('login.html', error="Usuario o contraseña incorrectos")
return render_template('login.html') @app.route('/') def index(): if
current_user.is_authenticated: return redirect(url_for('dashboard')) return
redirect(url_for('login')) @app.route('/logout') @login_required def logout():
logout_user() return redirect(url_for('login')) @app.route('/dashboard')
@login_required def dashboard(): return render_template('dashboard.html')
@app.route('/add-question', methods=['GET', 'POST']) @login_required def
add_question(): if request.method == 'POST': level = request.form.get('level')
correct_answer = request.form.get('correct_answer') options = { 'a':
request.form.get('option_a'), 'b': request.form.get('option_b'), 'c':
request.form.get('option_c'), 'd': request.form.get('option_d') } if
'question_image' not in request.files: return "No se encontró el archivo de
imagen" file = request.files['question_image'] if file.filename == '': return
"No se seleccionó ningún archivo" if file: filename =
secure_filename(file.filename) filepath =
os.path.join(app.config['UPLOAD_FOLDER'], filename) file.save(filepath)
new_question = { 'question_image': filename, 'options': options, 'correct':
correct_answer, 'level': level } db.collection('questions').add(new_question)
return redirect(url_for('add_question')) return
render_template('add_question.html') @app.route('/manage-questions')
@login_required def manage_questions(): questions_ref =
db.collection('questions').stream() questions = {} for doc in questions_ref:
question_data = doc.to_dict() level = question_data.get('level') if level not in
questions: questions[level] = [] questions[level].append({'id': doc.id,
**question_data}) return render_template('manage_questions.html',
nivel1=questions.get('nivel1', []), nivel2=questions.get('nivel2', []),
nivel3=questions.get('nivel3', [])) @app.route('/delete-question/<question_id
  >', methods=['POST']) @login_required def delete_question(question_id):
  question_ref = db.collection('questions').document(question_id)
  question_to_delete = question_ref.get().to_dict() if question_to_delete:
  image_path = os.path.join(app.config['UPLOAD_FOLDER'],
  question_to_delete.get('question_image')) if os.path.exists(image_path):
  os.remove(image_path) question_ref.delete() return
  redirect(url_for('manage_questions')) @app.route('/manage-teams',
  methods=['GET', 'POST']) @login_required def manage_teams(): return
  render_template('manage_teams.html') @app.route('/update-team-name/<team_id
    >', methods=['POST']) @login_required def update_team_name(team_id):
    new_name = request.form.get('new_name') if new_name:
    db.collection('teams').document(team_id).update({'name': new_name}) return
    redirect(url_for('manage_teams')) @app.route('/delete-team/<team_id
      >', methods=['POST']) @login_required def delete_team(team_id):
      db.collection('teams').document(team_id).delete() return
      redirect(url_for('manage_teams')) @app.route('/scoreboard')
      @login_required def show_scoreboard(): teams_ref =
      db.collection('teams').stream() scores = {doc.to_dict()['name']:
      doc.to_dict().get('score', 0) for doc in teams_ref} return
      render_template('scoreboard.html', scores=scores)
      @app.route('/reset-points', methods=['POST']) @login_required def
      reset_points(): teams_ref = db.collection('teams').stream() for doc in
      teams_ref: db.collection('teams').document(doc.id).update({'score': 0})
      return redirect(url_for('show_scoreboard')) @app.route('/select-level',
      methods=['GET', 'POST']) @login_required def select_level(): teams_ref =
      db.collection('teams').stream() teams = [doc.to_dict()['name'] for doc in
      teams_ref] if request.method == 'POST': level = request.form.get('level')
      team1 = request.form.get('team1') team2 = request.form.get('team2')
      session['quiz_level'] = level session['quiz_teams'] = [team1, team2]
      return redirect(url_for('start_quiz')) return
      render_template('select_level.html', teams=teams)
      @app.route('/start-quiz') @login_required def start_quiz(): level =
      session.get('quiz_level') quiz_pool = [doc.to_dict() for doc in
      db.collection('questions').where('level', '==', level).stream()]
      random.shuffle(quiz_pool) session['quiz_pool'] = quiz_pool
      session['current_question_index'] = 0 selected_teams =
      session.get('quiz_teams', []) session['quiz_scores'] = {team: 0 for team
      in selected_teams} return redirect(url_for('countdown'))
      @app.route('/countdown') @login_required def countdown(): return
      render_template('countdown.html') @app.route('/quiz-question')
      @login_required def quiz_question(): index =
      session.get('current_question_index') quiz_pool = session.get('quiz_pool')
      if not quiz_pool or index >= len(quiz_pool): return
      redirect(url_for('quiz_finished')) question = quiz_pool[index]
      session['current_question'] = question return render_template('quiz.html',
      question=question, question_number=index + 1) @app.route('/submit-answer',
      methods=['POST']) @login_required def submit_answer(): user_answer =
      request.form.get('answer') question = session.get('current_question')
      is_correct = user_answer == question['correct'] teams_in_quiz =
      session.get('quiz_scores', {}) if not is_correct: return
      render_template('assign_point.html', is_correct=False, old_question=True,
      teams=teams_in_quiz) else: return render_template('assign_point.html',
      is_correct=True, old_question=False, teams=teams_in_quiz)
      @app.route('/assign-point-to-team', methods=['POST']) @login_required def
      assign_point_to_team(): team = request.form.get('team') old_question_flag
      = request.form.get('old_question_flag') if team in session['quiz_scores']:
      session['quiz_scores'][team] += 1 for score in
      session['quiz_scores'].values(): if score >= 3: return
      redirect(url_for('quiz_finished')) if old_question_flag == 'False':
      session['current_question_index'] += 1 return
      redirect(url_for('quiz_question')) @app.route('/skip-question')
      @login_required def skip_question(): session['current_question_index'] +=
      1 return redirect(url_for('quiz_question'))
      @app.route('/quiz-finished'</team_id
    ></team_id
  ></question_id
>
